#
# SPDX-FileCopyrightText: Copyright (c) 2024-2025 NVIDIA CORPORATION & AFFILIATES. All rights reserved.
# SPDX-License-Identifier: Apache-2.0
#
name: Plugin Tests

on:
  push:
    branches: [ main, develop ]
    paths:
      - 'plugins/**'
      - '.github/workflows/test-plugins.yml'
  pull_request:
    branches: [ main, develop ]
    paths:
      - 'plugins/**'
      - '.github/workflows/test-plugins.yml'
  workflow_dispatch:

env:
  PYTHON_VERSION: '3.10'

jobs:
  validate-manifests:
    name: Validate Plugin Manifests
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          submodules: false

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: Install dependencies
        run: |
          pip install pyyaml pytest

      - name: Validate manifests
        run: |
          cd plugins
          python3 testing/framework/test_runner.py --validate

  # GPU-accelerated tests (requires self-hosted runner with GPU)
  gpu-tests:
    name: GPU Plugin Tests
    runs-on: [self-hosted, linux, gpu]
    needs: validate-manifests
    if: github.event_name != 'pull_request' || contains(github.event.pull_request.labels.*.name, 'test-gpu')

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
            submodules: recursive

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: Install Python dependencies
        run: |
          python3 -m pip install --upgrade pip
          pip install -r requirements.txt

      - name: Check GPU availability
        run: |
          if command -v nvidia-smi >/dev/null 2>&1; then
            if nvidia-smi -L | grep -q 'GPU '; then
              echo "has_gpu=true" >> $GITHUB_ENV
              nvidia-smi
            else
              echo "has_gpu=false" >> $GITHUB_ENV
              echo "::warning::nvidia-smi found but no GPUs detected; skipping plugin tests."
            fi
          else
            echo "has_gpu=false" >> $GITHUB_ENV
            echo "::warning::No GPU detected on runner; skipping plugin tests."
          fi

      - name: Build plugins
        if: env.has_gpu == 'true'
        run: |
          bash plugins/common/build_all_plugins.sh --host
          bash plugins/common/build_all_plugins.sh --container

      - name: Run plugin tests
        if: env.has_gpu == 'true'
        run: |
          bash plugins/testing/run_all_tests.sh --verbose
